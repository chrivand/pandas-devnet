# Hands-on excercise: calculate average bytes per flow per host group
In this step you will learn how to calculate the average bytes per flow per host group. In this use case, the dataset contains three types of host groups: 

* Web Servers
* End User Devices
* Desktops

Let's see what the differences are for each host group in terms of the average bytes per flow. 

## Objectives

After this step, you should be able to:

* Create a mapping between a source and destination
* Calculate the average for each unique mapping


## Code
Follow the following steps for the exercise:

1. In order to calculate the average bytes per flow per host group, we need to create a mapping between the host groups. Through a `for` loop, we loop through all the rows of the DataFrame and we create a `subject_peer_pair`:

    ```python
    for _, row in df.iterrows():
        subject_peer_pair = row['Subject Host Groups'] + ":" + row['Peer Host Groups']
      ```
2. The mapping between the host groups will be used as a key in our `aggregates_dict`, which is a dictionary where we store all the Bytes that are flowing between the `subject_peer_pairs`. We simply check whether the key already exists in the dictionary or not. If it does exist already, then we append it to the existing value. Otherwise, we create a new key-value pair in the dictionary. 

      ```python
      aggregates_dict = {}
        for _, row in df.iterrows():
            subject_peer_pair = row['Subject Host Groups'] + ":" + row['Peer Host Groups']
            if subject_peer_pair in aggregates_dict:
                aggregates_dict[subject_peer_pair].append(row['Total Bytes'])
            else:
                aggregates_dict[subject_peer_pair] = [row['Total Bytes']]
      ```

3. After having aggregated a list of flows for each `subject_peer_pair`, we have to calculate the average for each pair. For this, we create a new dictionary called `averages_dict`, where we store the average bytes per flow per host group. We compute the average using the `mean()` function of the `numpy` library:

    ```python
    averages_dict = {}
    for key in aggregates_dict:
        total_bytes_per_hostgroup = aggregates_dict[key]
        average_bytes_per_flow_per_hostgroup = np.mean(total_bytes_per_hostgroup)
        averages_dict[key] = average_bytes_per_flow_per_hostgroup
    ```
4. We can put everything together and we obtain the following function: 

    ```python
    def average_bytes_per_flow_per_hostgroup(df):
      aggregates_dict = {}
      for _, row in df.iterrows():
          subject_peer_pair = row['Subject Host Groups'] + ":" + row['Peer Host Groups']
          if subject_peer_pair in aggregates_dict:
              aggregates_dict[subject_peer_pair].append(row['Total Bytes'])
          else:
              aggregates_dict[subject_peer_pair] = [row['Total Bytes']]

      averages_dict = {}
      for key in aggregates_dict:
          total_bytes_per_hostgroup = aggregates_dict[key]
          average_bytes_per_flow_per_hostgroup = np.mean(total_bytes_per_hostgroup)
          averages_dict[key] = average_bytes_per_flow_per_hostgroup

      return averages_dict
    ```
**Next Step: Hands-on excercise: detect above-average flows**