# Hands-on excercise: calculate average bytes per flow per host group
In this step you will learn how to calculate the average bytes per flow per host group. In this use case, the dataset contains three types of host groups: 

* Web Servers
* End User Devices
* Desktops

Let's see what the differences are for each host group in terms of the average bytes per flow. 

## Objectives

After this step, you should be able to:

* Create a mapping between a source and destination
* Calculate the average for each unique mapping


## Code
Follow the following steps for the exercise:

1. Let's clean up the dataset a bit more, so that we can calculate the amount of data that was received and sent per host group. For the purpose of this lab, we will strip off all, except the first, `Subject Host Groups` and `Peer Host Groups`. For example, this would be the result for a flow:

`"Subject Host Groups": "Web Servers, End User Devices, Desktops, Atlanta, Sales and Marketing"`

`"Subject Host Groups": "Web Servers"`

> **Note:** Cisco Secure Network Analytics has a very powerfull engine to keep track of multiple host groups and IP changes. For the purpose of this labs, we are simplifying this.

2. To strip of the excess host groups, we are going to use the `strip_host_groups(text)` function. To do this, please uncomment the following lines in the `main()` function on line X-X and run the python script again in your terminal window.

```
    # Hands-on excercise: calculate average bytes per flow per host group
    #TODO df['Subject Host Groups'] =  df['Subject Host Groups'].apply(strip_host_groups)
    #TODO df['Peer Host Groups'] =  df['Peer Host Groups'].apply(strip_host_groups)
```

TODO

3. In order to calculate the average bytes per flow per host group, we need to create a mapping between the host groups. Through a `for` loop, we loop through all the rows of the DataFrame and we create a `subject_peer_pair`:

    ```python
    for _, row in df.iterrows():
        subject_peer_pair = row['Subject Host Groups'] + ":" + row['Peer Host Groups']
    ```

4. The mapping between the host groups will be used as a key in our `aggregates_dict`, which is a dictionary where we store all the Bytes that are flowing between the `subject_peer_pairs`. We simply check whether the key already exists in the dictionary or not. If it does exist already, then we append it to the existing value. Otherwise, we create a new key-value pair in the dictionary. 

      ```python
      aggregates_dict = {}
      for _, row in df.iterrows():
          subject_peer_pair = row['Subject Host Groups'] + ":" + row['Peer Host Groups']
          if subject_peer_pair in aggregates_dict:
              aggregates_dict[subject_peer_pair].append(row['Total Bytes'])
          else:
              aggregates_dict[subject_peer_pair] = [row['Total Bytes']]
      ```

5. After having aggregated a list of flows for each `subject_peer_pair`, we have to calculate the average for each pair. For this, we create a new dictionary called `averages_dict`, where we store the average bytes per flow per host group. We compute the average using the `mean()` function of the `numpy` library:

    ```python
    averages_dict = {}
    for key in aggregates_dict:
        total_bytes_per_hostgroup = aggregates_dict[key]
        average_bytes_per_flow_per_hostgroup = np.mean(total_bytes_per_hostgroup)
        averages_dict[key] = average_bytes_per_flow_per_hostgroup
    ```
6. We can put everything together and we obtain the following function: 

    ```python
    def average_bytes_per_flow_per_hostgroup(df):
      aggregates_dict = {}
      for _, row in df.iterrows():
          subject_peer_pair = row['Subject Host Groups'] + ":" + row['Peer Host Groups']
          if subject_peer_pair in aggregates_dict:
              aggregates_dict[subject_peer_pair].append(row['Total Bytes'])
          else:
              aggregates_dict[subject_peer_pair] = [row['Total Bytes']]

      averages_dict = {}
      for key in aggregates_dict:
          total_bytes_per_hostgroup = aggregates_dict[key]
          average_bytes_per_flow_per_hostgroup = np.mean(total_bytes_per_hostgroup)
          averages_dict[key] = average_bytes_per_flow_per_hostgroup

      return averages_dict
    ```
**Next Step: Hands-on excercise: detect above-average flows**