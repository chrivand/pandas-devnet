# Hands-on excercise: calculate average bytes per flow per host group
In this step you will learn how to calculate the average bytes per flow per host group. In this use case, the dataset contains three types of host groups: 

* Web Servers
* End User Devices
* Desktops

Let's see what the differences are for each host group in terms of the average bytes per flow. 

## Objectives

After this step, you should be able to:

* Learn how to use the `.groupby()` method of `pandas`. 
* Calculate the mean of a grouped DataFrame
* Use the `.unique()` method of `pandas`


## Code
Follow the following steps for the exercise:

1. Let's clean up the dataset a bit more, so that we can calculate the amount of data that was received and sent per host group. For the purpose of this lab, we will strip off all, except the first, `Subject Host Groups` and `Peer Host Groups`. For example, this would be the result for a flow:

`"Subject Host Groups": "Web Servers, End User Devices, Desktops, Atlanta, Sales and Marketing"`

To this:

`"Subject Host Groups": "Web Servers"`

> **Note:** Cisco Secure Network Analytics has a very powerful engine to keep track of multiple host groups and IP changes. For the purpose of this labs, we are simplifying this.

2. To strip of the excess host groups, we are going to use the `strip_host_groups(text)` function. To do this, please uncomment the following lines in the `main()` function and run the python script again in your terminal window.

```
    # Hands-on excercise: calculate average bytes per flow per host group
    #TODO df['Subject Host Groups'] =  df['Subject Host Groups'].apply(strip_host_groups)
    #TODO df['Peer Host Groups'] =  df['Peer Host Groups'].apply(strip_host_groups)
```

3. In order to calculate the average bytes per flow per host group, we have to aggregate the total number of bytes per host group. Fortunately, there is a built-in function in `pandas` that can group the values in a column and return us aggregates. 

We loop through the unique values in the `Subject Host Groups` column and for each unique hostgroup, we filter out all its values, which we store in an `aggregates_dict`.

```python
def aggregate_bytes_per_hostgroup_sent_or_received(df, sent_or_received):
    peer_or_subject_bytes = check_sent_or_received(sent_or_received)

    aggregates_dict = {}
    for hostgroup in df['Subject Host Groups'].unique():
        hostgroup_index = df.groupby(by="Subject Host Groups").groups[hostgroup]
        bytes_values = df.iloc[hostgroup_index][peer_or_subject_bytes].values
        aggregates_dict[hostgroup] = bytes_values

    return aggregates_dict
```

>**Note** The function takes two values, the DataFrame and a string indicating the direction of the flow, i.e., `'sent'` or `'received'`. The function `check_sent_or_received` checks whether the input is either one of the options and if not, it will raise an exception. 

4. In a similar way, we can also calculate the average number of bytes per hostgroup in either direction. We simply loop through the hostgroups again and group the values again using the `groupby` function. We group by the `Subject Host Groups` and we take the mean of it. The result of it will be stored in a dictionary. 

```python
def average_bytes_per_hostgroup_sent_or_received(df, sent_or_received):
    peer_or_subject_bytes = check_sent_or_received(sent_or_received)

    averages_dict = {}
    for hostgroup in df['Subject Host Groups'].unique():
        hostgroup_index = df.groupby(by="Subject Host Groups").groups[hostgroup]
        bytes_averages = df.iloc[hostgroup_index][peer_or_subject_bytes].values.mean()
        averages_dict[hostgroup] = bytes_averages
    return averages_dict
```

5. Now, go ahead and try it yourself! Uncomment the below lines in the main function by deleting the `#TODO `: 

```python
# Hands-on excercise: calculate average bytes per flow per host group
#TODO df['Subject Host Groups'] =  df['Subject Host Groups'].apply(strip_host_groups)
#TODO df['Peer Host Groups'] =  df['Peer Host Groups'].apply(strip_host_groups)

#TODO total_sent = aggregate_bytes_per_hostgroup_sent_or_received(df, 'sent')
#TODO total_received = aggregate_bytes_per_hostgroup_sent_or_received(df, 'received')
#TODO print(average_bytes_per_hostgroup_sent_or_received(df, 'sent'))
#TODO print(average_bytes_per_hostgroup_sent_or_received(df, 'received'))
```

**Next Step: Hands-on excercise: detect above-average flows**