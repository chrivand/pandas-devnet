# Detect above-average flows

In the last exercise, we create a script that can detect above-average flows. 

* Learn how to plot using `matplotlib.pyplot`
* Compare values and return a value based on this comparison. 
* Learn how to use the `query()` method of `pandas`
* Learn how to concatenate a list of DataFrames into one DataFrame

## Detect the outliers in the data

Take a closer look at the DataFrame and try to detect outliers among the collected data. 

1. Usually, you start by inspecting the data manually to get a feel for the data, using the `matploblib.pyplot` library. This code plots the number of bytes sent and received per host group: 

```python
def plot_flows(aggregates_dict, sent_or_received):
    for subject_host_group in aggregates_dict:
        plt.figure()
        x = np.arange(len(aggregates_dict[subject_host_group]))
        y = np.array(aggregates_dict[subject_host_group])

        plt.plot(x,y)
        plt.title(f'The number of bytes {sent_or_received} from {subject_host_group}')
        plt.ylabel('Bytes')
        
        plt.show()
```

![received_cloud](assets/images/flows_received_on_Cloud_Hosts.png)
![received_end_user](assets/images/flows_received_on_End_User_Devices.png)
![received_web_servers](assets/images/flows_received_on_Web_Servers.png)
![sent_cloud](assets/images/flows_sent_from_Cloud_Hosts.png)
![sent_end_user](assets/images/flows_sent_from_End_User_Devices.png)
![sent_web_servers](assets/images/flows_sent_from_Web_Servers.png)

From this output, you can see that there are some clear outliers that are heavily influencing the averages. 

2. Now you can filter out the anomalies and outliers in the DataFrame. You need to extract the values that exceed the average. Pandas has a built-in method that enables you to query in the style of SQL:

```python
df.query('`Subject Bytes`>1000 & `Subject Host Groups`=="Web Servers"')
``` 
This query lists the rows where the `Subject Bytes` exceed 1000 and where the `Subject Host Groups` is equal to `Web Servers`. You can apply this query to all host groups: 

```python 
for subject_host_group in averages_dict:
        sub_df = df.query(f'`Subject Bytes` > {averages_dict[subject_host_group]} & `Subject Host Groups` == "{subject_host_group}"')
```

3. Store the output of the query in a DataFrame. You can also concatenate these DataFrames into one DataFrame by putting all these DataFrames in a list and passing this list onto the `concat()` method of `pandas`. 

```python
def detect_above_average_flows(df, sent_or_received):
    peer_or_subject_bytes = check_sent_or_received(sent_or_received)
    averages_dict = average_bytes_per_hostgroup_sent_or_received(df, sent_or_received)

    df_list = []
    for subject_host_group in averages_dict:
        sub_df = df.query(f'`Subject Bytes` > {averages_dict[subject_host_group]} & `Subject Host Groups` == "{subject_host_group}"')
        df_list.append(sub_df)
    anomaly_df = pd.concat(df_list)
    return anomaly_df
```

4. Go ahead and try it out yourself! Inspect the anomalies manually and try to understand what is happening for each situation. Uncomment the below lines by deleting the `#TODO ` to execute the anomalies. 

```python
# Hands-on excercise: detect above-average flows
#TODO plot_flows(total_sent, 'sent')
#TODO plot_flows(total_received, 'received)
#TODO print(detect_above_average_flows(df, "sent"))
#TODO print(detect_above_average_flows(df, "received"))
```

5. As you can see the following flow is the top outlier:

```
{
      "Start": "2021-05-11T03:40:03.000+0000",
      "Duration": "7hr 57min 56s",
      "Subject IP Address": "10.201.3.20",
      "Subject Port/Protocol": "50928/TCP",
      "Subject Host Groups": "Web Servers, End User Devices, Desktops, Atlanta, Sales and Marketing",
      "Subject Bytes": "424.39 M",
      "Application": "Xsan Filesystem",
      "Total Bytes": "848.77 M",
      "Peer IP Address": "10.201.1.51",
      "Peer Port/Protocol": "22609/TCP",
      "Peer Host Groups": "Web Servers, Atlanta",
      "Peer Bytes": "424.39 M",
      "Actions": ""
}
  ```
  
  6. This could indicate that this host is compromised, and a malicious actor is trying to exfiltrate data. Luckily it seems that both the `Subject` and `Peer` are internal IP addresses, so this will most likely not be something to alert on. It does show how very basic forms of anomoly detection works. Luckily the algorithms of Cisco Secure Network Analytics are much more sophisticated than this.  

**Next Step: Wrap-Up**